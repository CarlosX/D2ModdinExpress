// Generated by CoffeeScript 1.4.0
(function() {
  "use strict";

  var LobbyService, global;

  global = this;

  LobbyService = (function() {

    function LobbyService($rootScope, $authService) {
      this.lobbies = [];
      this.publicLobbies = [
        {
          _id: "someid",
          banned: [],
          creator: "Quantum",
          creatorid: "someid",
          deleted: false,
          devMode: false,
          dire: [null, null, null, null, null],
          radiant: [null, null, null, null, null],
          enableGG: true,
          hasPassword: false,
          isPublic: true,
          mod: "ura55vChSgFo6LHgz",
          name: "Test Lobby",
          password: "",
          region: 1,
          requiresFullLobby: true,
          serverIP: "",
          state: 0,
          status: 0
        }
      ];
      this.socket = null;
      this.scope = $rootScope;
      this.auth = $authService;
      this.hasAuthed = false;
      this.status = {
        managerConnected: false,
        managerStatus: "Manager status unknown, checking...",
        managerDownloading: false
      };
      this.colls = {
        lobbies: this.lobbies,
        publicLobbies: this.publicLobbies
      };
    }

    LobbyService.prototype.disconnect = function() {
      if (this.socket !== null) {
        this.socket = null;
      }
      this.hasAuthed = false;
      return console.log("Disconnected.");
    };

    LobbyService.prototype.send = function(data) {
      if (!(this.socket != null)) {
        return;
      }
      return this.socket.publish('data', data);
    };

    LobbyService.prototype.call = function(method, params) {
      var data;
      data = {
        id: method,
        req: params
      };
      console.log(data);
      return this.send(data);
    };

    LobbyService.prototype.installMod = function(modname) {
      this.call("installmod", {
        mod: modname
      });
      this.status.managerDownloading = true;
      return this.scope.$digest();
    };

    LobbyService.prototype.createLobby = function(name, modid) {
      return this.call("createlobby", {
        name: name,
        mod: modid
      });
    };

    LobbyService.prototype.sendAuth = function() {
      if (!this.auth.isAuthed) {
        return this.disconnect();
      } else {
        if (!this.hasAuthed) {
          if (!(this.socket != null)) {
            return this.connect();
          } else {
            return this.send({
              id: 'auth',
              uid: this.auth.user._id,
              key: this.auth.token
            });
          }
        }
      }
    };

    LobbyService.prototype.handleMsg = function(data) {
      var coll, eve, id, idx, obj, op, upd, _i, _len, _ref, _results;
      switch (data.msg) {
        case "error":
          return $.pnotify({
            title: "Lobby Error",
            text: data.reason,
            type: "error"
          });
        case "chat":
          return this.scope.$broadcast('lobby:chatMsg', data.message);
        case "modneeded":
          return this.scope.$broadcast('lobby:modNeeded', data.name);
        case "installres":
          this.status.managerDownloading = false;
          return this.scope.$broadcast('lobby:installres', data.success);
        case "colupd":
          _ref = data.ops;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            upd = _ref[_i];
            coll = this.colls[upd._c];
            eve = "lobbyUpdate:" + upd._c;
            op = upd._o;
            delete upd["_o"];
            delete upd["_c"];
            switch (op) {
              case "insert":
                coll.push(upd);
                break;
              case "update":
                id = upd._id;
                delete upd["_id"];
                obj = _.findWhere(coll, {
                  _id: id
                });
                if (obj != null) {
                  _.extend(obj, upd);
                }
                break;
              case "remove":
                id = upd._id;
                obj = _.findWhere(coll, {
                  _id: id
                });
                if (obj != null) {
                  idx = coll.indexOf(obj);
                  if (idx !== -1) {
                    coll.splice(idx, 1);
                  }
                }
            }
            _results.push(this.scope.$emit(eve, op));
          }
          return _results;
      }
    };

    LobbyService.prototype.connect = function() {
      var so,
        _this = this;
      this.disconnect();
      console.log("Attempting connection...");
      this.socket = so = new XSockets.WebSocket('ws://127.0.0.1:4502/BrowserController');
      so.on('auth', function(data) {
        if (data.status) {
          $.pnotify({
            title: "Authenticated",
            text: "You are now authenticated with the lobby server.",
            type: "success"
          });
          return _this.hasAuthed = true;
        } else {
          _this.lobbies.length = 0;
          _this.publicLobbies.length = 0;
          _this.scope.$digest();
          $.pnotify({
            title: "Deauthed",
            text: "You are no longer authed with the lobby server.",
            type: "error"
          });
          return _this.hasAuthed = false;
        }
      });
      so.on('lobby', function(msg) {
        return _this.handleMsg(msg);
      });
      so.on('manager', function(msg) {
        if (msg.msg === 'status') {
          if (msg.status) {
            _this.status.managerConnected = true;
            _this.status.managerStatus = "Manager running and ready.";
          } else {
            _this.status.managerConnected = false;
            _this.status.managerStatus = "Manager is not connected.";
          }
          return _this.scope.$digest();
        }
      });
      so.on("close", function() {
        _this.lobbies.length = 0;
        _this.publicLobbies.length = 0;
        _this.status.managerConnected = false;
        _this.status.managerStatus = "You have lost connection with the lobby server...";
        _this.scope.$digest();
        _this.socket = null;
        return $.pnotify({
          title: "Disconnected",
          text: "Disconnected from the lobby server.",
          type: "error"
        });
      });
      return so.on("open", function(clientinfo) {
        console.log("OnOpen");
        $.pnotify({
          title: "Connected",
          text: "Connected to the lobby server",
          type: "success"
        });
        _this.lobbies.length = 0;
        _this.publicLobbies.length = 0;
        _this.scope.$digest();
        return _this.sendAuth();
      });
    };

    return LobbyService;

  })();

  angular.module("d2mp.services", []).factory("$authService", [
    "$interval", "$http", "$log", "$rootScope", function($interval, $http, $log, $rootScope) {
      var authService, updateAuth;
      updateAuth = function() {
        $http({
          method: "GET",
          url: "/data/authStatus"
        }).success(function(data, status, headers, config) {
          if (data.isAuthed !== authService.isAuthed) {
            $log.log("Authed: " + data.isAuthed);
            authService.isAuthed = data.isAuthed;
            $rootScope.$broadcast("auth:isAuthed", data.isAuthed);
          }
          authService.user = data.user;
          authService.token = data.token;
        }).error(function(data, status, headers, config) {
          $log.log("Error fetching auth status: " + data);
        });
      };
      authService = {};
      authService.update = updateAuth;
      updateAuth();
      $interval(updateAuth, 60000);
      return authService;
    }
  ]).factory("$lobbyService", [
    "$interval", "$log", "$authService", "$rootScope", function($interval, $log, $authService, $rootScope) {
      var service;
      service = new LobbyService($rootScope, $authService);
      $rootScope.$on("auth:isAuthed", function() {
        return service.sendAuth();
      });
      service.sendAuth();
      global.service = service;
      return service;
    }
  ]).factory('$forceLobbyPage', [
    '$rootScope', '$location', '$lobbyService', function($rootScope, $location, $lobbyService) {
      $rootScope.$on('lobbyUpdate:lobbies', function(op) {
        if (op === 'update' || op === 'insert') {
          if ($location.path() !== "lobby") {
            $location.url("/lobby/" + $lobbyService.lobbies[0]._id);
            return $rootScope.$apply();
          }
        } else {
          if ($location.path() === "lobby") {
            $location.path('/lobbies');
            return $rootScope.$apply();
          }
        }
      });
      $rootScope.$on('lobby:modNeeded', function(event, mod) {
        $location.url('/install/' + mod);
        return $rootScope.$apply();
      });
      return $rootScope.$on('$locationChangeStart', function(event, newurl, oldurl) {
        if ($lobbyService.lobbies.length > 0) {
          event.preventDefault();
          if ($location.path() !== "lobby") {
            $location.url("/lobby/" + $lobbyService.lobbies[0]._id);
            return $rootScope.$apply();
          }
        } else {
          if (newurl.indexOf('/lobby/') !== -1) {
            $location.url('/lobbies');
            return $rootScope.$apply();
          }
        }
      });
    }
  ]);

}).call(this);
